{% extends "base.html" %}

{% block title %}Timesheets - Timerrr{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-10">
    <div class="mb-5 sm:mb-6">
        <h1 class="text-xl sm:text-2xl font-semibold mb-1">Timesheets</h1>
        <p class="text-sm text-gray-600">Generate and download timesheets for any date range.</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-5 mb-5 sm:mb-6">
        <h2 class="text-base font-medium text-gray-700 mb-4">Generate New Timesheet</h2>

        <div class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                <div>
                    <label class="block text-xs sm:text-sm text-gray-500 mb-1">Client</label>
                    <select id="client-select" class="w-full px-2.5 py-1.5 border border-gray-300 rounded-md
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                                   bg-white text-sm">
                        <option value="">Select a client</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm text-gray-500 mb-1">Start Date</label>
                    <input id="start-date" type="date" class="w-full px-2.5 py-1.5 border border-gray-300 rounded-md
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                                   bg-white text-sm">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm text-gray-500 mb-1">End Date</label>
                    <input id="end-date" type="date" class="w-full px-2.5 py-1.5 border border-gray-300 rounded-md
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                                   bg-white text-sm">
                </div>
            </div>

            <div>
                <label class="block text-xs sm:text-sm text-gray-500 mb-2">Quick Presets</label>
                <div class="flex flex-wrap gap-2">
                    <button type="button" data-days="7" class="preset-btn px-3 py-1.5 rounded-md text-sm border border-gray-300 hover:bg-gray-100 transition-colors">1 Week</button>
                    <button type="button" data-days="14" class="preset-btn px-3 py-1.5 rounded-md text-sm border border-gray-300 hover:bg-gray-100 transition-colors">2 Weeks</button>
                    <button type="button" data-days="28" class="preset-btn px-3 py-1.5 rounded-md text-sm border border-gray-300 hover:bg-gray-100 transition-colors">4 Weeks</button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pt-1">
                <p class="text-xs sm:text-sm text-gray-500">
                    Timezone: <span id="timezone-label" class="font-medium text-gray-700">UTC</span>
                </p>
                <button id="generate-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white
                               px-4 sm:px-5 py-1.5 rounded-md font-medium transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    Generate CSV
                </button>
            </div>
        </div>

        <div id="error-message" class="mt-3 hidden">
            <p class="text-sm text-red-600"></p>
        </div>
        <div id="success-message" class="mt-3 hidden">
            <p class="text-sm text-green-600"></p>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-5">
        <h2 class="text-base font-medium text-gray-700 mb-4">Generated Timesheets</h2>
        <div id="timesheets-container">
            <div class="text-center py-8">
                <p class="text-gray-500 text-sm">Loading timesheets...</p>
            </div>
        </div>
    </div>
</div>

<script>
const PRESET_ACTIVE_CLASSES = 'bg-gray-900 text-white border-gray-900';
const PRESET_INACTIVE_CLASSES = 'border-gray-300 hover:bg-gray-100';

let browserTimezone = 'UTC';

document.addEventListener('DOMContentLoaded', function() {
    browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    document.getElementById('timezone-label').textContent = browserTimezone;

    loadClients();
    loadTimesheets();
    applyPresetRange(7);

    document.getElementById('generate-btn').addEventListener('click', generateTimesheet);
    document.querySelectorAll('.preset-btn').forEach(button => {
        button.addEventListener('click', () => {
            const days = parseInt(button.dataset.days, 10);
            applyPresetRange(days);
        });
    });

    document.getElementById('start-date').addEventListener('input', clearPresetSelection);
    document.getElementById('end-date').addEventListener('input', clearPresetSelection);
});

function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function applyPresetRange(days) {
    const end = new Date();
    end.setHours(0, 0, 0, 0);

    const start = new Date(end);
    start.setDate(start.getDate() - (days - 1));

    document.getElementById('start-date').value = formatDateForInput(start);
    document.getElementById('end-date').value = formatDateForInput(end);

    document.querySelectorAll('.preset-btn').forEach(button => {
        if (parseInt(button.dataset.days, 10) === days) {
            button.className = `preset-btn px-3 py-1.5 rounded-md text-sm border transition-colors ${PRESET_ACTIVE_CLASSES}`;
        } else {
            button.className = `preset-btn px-3 py-1.5 rounded-md text-sm border transition-colors ${PRESET_INACTIVE_CLASSES}`;
        }
    });
}

function clearPresetSelection() {
    document.querySelectorAll('.preset-btn').forEach(button => {
        button.className = `preset-btn px-3 py-1.5 rounded-md text-sm border transition-colors ${PRESET_INACTIVE_CLASSES}`;
    });
}

async function loadClients() {
    try {
        const response = await fetch('/api/clients');
        if (!response.ok) throw new Error('Failed to load clients');

        const clients = await response.json();
        const select = document.getElementById('client-select');
        select.innerHTML = '<option value="">Select a client</option>';

        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

async function loadTimesheets() {
    try {
        const response = await fetch('/api/timesheets');
        if (!response.ok) throw new Error('Failed to load timesheets');

        const timesheets = await response.json();
        const container = document.getElementById('timesheets-container');

        if (timesheets.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-500 text-sm">No timesheets generated yet.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = '<div class="space-y-3">' +
            timesheets.map(timesheet => createTimesheetElement(timesheet)).join('') +
            '</div>';
    } catch (error) {
        console.error('Error loading timesheets:', error);
        const container = document.getElementById('timesheets-container');
        container.innerHTML = `
            <div class="text-center py-8">
                <p class="text-red-500 text-sm">Failed to load timesheets</p>
            </div>
        `;
    }
}

function createTimesheetElement(timesheet) {
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    const createdDate = new Date(timesheet.created_at).toLocaleDateString();

    const totalSeconds = Math.round(timesheet.total_hours * 3600);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const formattedTime = `${hours}h ${minutes}m ${seconds}s`;

    const isRange = timesheet.period_type === 'range' && timesheet.start_date && timesheet.end_date;
    const periodLabel = isRange
        ? `${timesheet.start_date} to ${timesheet.end_date}`
        : `${monthNames[timesheet.month] || ''} ${timesheet.year || ''}`.trim();
    const timezoneLabel = isRange ? ` • ${timesheet.timezone || 'UTC'}` : '';

    return `
        <div class="p-3 sm:p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                    <div class="font-medium text-sm">${timesheet.client_name} - ${periodLabel}</div>
                    <div class="text-xs text-gray-500 mt-0.5">
                        ${formattedTime} (${timesheet.total_hours.toFixed(4)} hrs) • $${timesheet.total_amount.toFixed(2)}${timezoneLabel} • Generated on ${createdDate}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadTimesheet(${timesheet.id})" class="text-blue-600 hover:text-blue-700 text-xs sm:text-sm font-medium">Download</button>
                    <button onclick="deleteTimesheet(${timesheet.id})" class="text-red-600 hover:text-red-700 text-xs sm:text-sm font-medium">Delete</button>
                </div>
            </div>
        </div>
    `;
}

async function generateTimesheet() {
    const clientId = document.getElementById('client-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const generateBtn = document.getElementById('generate-btn');

    hideMessages();

    if (!clientId) {
        showError('Please select a client');
        return;
    }
    if (!startDate || !endDate) {
        showError('Please select a start and end date');
        return;
    }
    if (new Date(endDate) < new Date(startDate)) {
        showError('End date must be on or after start date');
        return;
    }

    const rangeDays = Math.floor((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
    if (rangeDays > 366) {
        showError('Date range cannot exceed 366 days');
        return;
    }

    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating...';

    try {
        const response = await fetch('/api/timesheets/generate-range', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_id: parseInt(clientId, 10),
                start_date: startDate,
                end_date: endDate,
                timezone: browserTimezone,
            }),
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate timesheet');
        }

        showSuccess('Timesheet generated successfully!');
        await loadTimesheets();
    } catch (error) {
        console.error('Error generating timesheet:', error);
        showError(error.message);
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate CSV';
    }
}

async function downloadTimesheet(timesheetId) {
    try {
        const response = await fetch(`/api/timesheets/${timesheetId}/download`);
        if (!response.ok) throw new Error('Failed to download timesheet');

        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'timesheet.csv';
        if (contentDisposition) {
            const match = contentDisposition.match(/filename="?(.*?)"?$/);
            if (match && match[1]) filename = match[1];
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Error downloading timesheet:', error);
        showError('Failed to download timesheet');
    }
}

async function deleteTimesheet(timesheetId) {
    if (!confirm('Are you sure you want to delete this timesheet?')) {
        return;
    }

    try {
        const response = await fetch(`/api/timesheets/${timesheetId}`, {
            method: 'DELETE',
        });
        if (!response.ok) throw new Error('Failed to delete timesheet');

        await loadTimesheets();
        showSuccess('Timesheet deleted successfully');
    } catch (error) {
        console.error('Error deleting timesheet:', error);
        showError('Failed to delete timesheet');
    }
}

function hideMessages() {
    document.getElementById('error-message').classList.add('hidden');
    document.getElementById('success-message').classList.add('hidden');
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.querySelector('p').textContent = message;
    errorDiv.classList.remove('hidden');
    setTimeout(() => errorDiv.classList.add('hidden'), 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    successDiv.querySelector('p').textContent = message;
    successDiv.classList.remove('hidden');
    setTimeout(() => successDiv.classList.add('hidden'), 3000);
}
</script>
{% endblock %}
